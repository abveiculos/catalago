<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Sistema de Gest√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                .sidebar { transition: transform 0.3s ease; height: 100vh; position: fixed; top: 0; left: 0; width: 256px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
        .sidebar-overlay.active { display: block; }
                @media (max-width: 1024px) { 
            .sidebar { 
                transform: translateX(-100%) !important;
            }
            .sidebar.open { 
                transform: translateX(0) !important;
            }
            .main-content {
                margin-left: 0 !important;
            }
        }
        .main-content { margin-left: 256px; min-height: 100vh; }
        @media (max-width: 1024px) { .main-content { margin-left: 0; } }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast { position: fixed; bottom: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease; min-width: 300px; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .dropzone { border: 2px dashed #cbd5e0; transition: all 0.3s ease; cursor: pointer; background: #f7fafc; }
        .dropzone.dragover { border-color: #667eea; background: #edf2f7; transform: scale(1.02); }
        .preview-img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; }
        .menu-item.active { background: #f3f4f6; color: #667eea; font-weight: 600; }
        .modal-overlay { backdrop-filter: blur(2px); }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <aside id="sidebar" class="sidebar">
        <div class="h-full flex flex-col">
            <div class="gradient-bg p-6 text-white">
                <div class="flex items-center space-x-3">
                    <i data-lucide="car" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-xl font-bold" id="nomeLoja">Alysson Bruno</h1>
                        <p class="text-xs opacity-90">Painel Admin</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 overflow-y-auto">
                <button onclick="mostrarAba('dashboard')" class="menu-item active w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left mb-2" data-tab="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
                </button>
                <button onclick="mostrarAba('veiculos')" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left mb-2" data-tab="veiculos">
                    <i data-lucide="car-front" class="w-5 h-5"></i><span>Ve√≠culos</span>
                </button>
                <button onclick="mostrarAba('leads')" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left mb-2" data-tab="leads">
                    <i data-lucide="users" class="w-5 h-5"></i><span>Leads</span>
                </button>
                <button onclick="mostrarAba('despesas')" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left mb-2" data-tab="despesas">
                    <i data-lucide="receipt" class="w-5 h-5"></i><span>Despesas</span>
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="mostrarAba('clientes')" data-tab="clientes" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="users" class="w-5 h-5"></i><span>Clientes</span>
                </button>
                <button onclick="sair()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i><span>Sair</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay do menu mobile -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="main-content">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg transition">
                        <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 id="tituloAba" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                </div>
                <button onclick="carregarDados()" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Atualizar dados">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main class="p-6">
            <div id="tab-dashboard" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg"><i data-lucide="car" class="w-6 h-6 text-blue-600"></i></div>
                        </div>
                        <p class="text-3xl font-bold text-gray-800" id="statEstoque">0</p>
                        <p class="text-sm text-gray-600 mt-1">Em Estoque</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-green-100 p-3 rounded-lg"><i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i></div>
                        </div>
                        <p class="text-3xl font-bold text-gray-800" id="statVendidos">0</p>
                        <p class="text-sm text-gray-600 mt-1">Vendidos</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-purple-100 p-3 rounded-lg"><i data-lucide="dollar-sign" class="w-6 h-6 text-purple-600"></i></div>
                        </div>
                        <p class="text-3xl font-bold text-gray-800" id="statLucro">R$ 0</p>
                        <p class="text-sm text-gray-600 mt-1">Lucro Total</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-yellow-100 p-3 rounded-lg"><i data-lucide="users" class="w-6 h-6 text-yellow-600"></i></div>
                        </div>
                        <p class="text-3xl font-bold text-gray-800" id="statLeads">0</p>
                        <p class="text-sm text-gray-600 mt-1">Leads Recebidos</p>
                    </div>
                </div>
            </div>

            <div id="tab-veiculos" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Gerenciar Ve√≠culos</h3>
                        <button onclick="abrirModalVeiculo()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition flex items-center shadow-md">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Adicionar Ve√≠culo
                        </button>
                    </div>
                    <div id="listaVeiculos" class="space-y-4"></div>
                </div>
            </div>

            <div id="tab-leads" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Gerenciar Leads</h3>
                    <div id="listaLeads" class="space-y-4"></div>
                </div>
            </div>

            <div id="tab-despesas" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Gerenciar Despesas</h3>
                        <button onclick="abrirModalDespesa()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition flex items-center shadow-md">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Adicionar Despesa
                        </button>
                    </div>
                    <div id="listaDespesas" class="space-y-4"></div>
                </div>

            <div id="tab-clientes" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Clientes Cadastrados</h3>
                        <button onclick="abrirModalCliente()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition flex items-center shadow-md">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>Adicionar Cliente
                        </button>
                    </div>
                    <div id="listaClientes" class="space-y-4"></div>
                </div>
            </div>

            </div>
        </main>
    </div>

    <div id="modalVeiculo" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-2xl font-bold text-gray-800" id="modalVeiculoTitulo">Adicionar Ve√≠culo</h3>
                <button onclick="fecharModalVeiculo()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="formVeiculo" onsubmit="salvarVeiculo(event)" class="space-y-6">
                    <input type="hidden" id="veiculoId">
                    <input type="hidden" id="veiculoPastaId">
                    <input type="hidden" id="veiculoPastaId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Marca*</label>
                            <input type="text" id="marca" list="listaMarcas" required 
                                   onchange="atualizarModelos()" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <datalist id="listaMarcas"></datalist>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Modelo*</label>
                            <input type="text" id="modelo" list="listaModelos" required 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <datalist id="listaModelos"></datalist>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ano*</label>
                            <input type="number" id="ano" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">KM*</label>
                            <input type="number" id="km" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Cor*</label>
                            <input type="text" id="cor" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Placa</label>
                            <input type="text" id="placa" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">C√¢mbio*</label>
                            <select id="cambio" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                                <option value="">Selecione</option><option value="Manual">Manual</option><option value="Autom√°tico">Autom√°tico</option>
                            </select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Combust√≠vel*</label>
                            <select id="combustivel" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                                <option value="">Selecione</option><option value="Flex">Flex</option><option value="Gasolina">Gasolina</option><option value="Diesel">Diesel</option><option value="El√©trico">El√©trico</option>
                            </select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Valor Compra*</label>
                            <input type="number" id="valor_compra" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Custos Adicionais</label>
                            <input type="number" id="custos_adicionais" value="0" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Valor Anunciado*</label>
                            <input type="number" id="valor_anunciado" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Status*</label>
                            <select id="status" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                                <option value="Dispon√≠vel">Dispon√≠vel</option><option value="Vendido">Vendido</option><option value="Reservado">Reservado</option>
                            </select></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                        <textarea id="descricao" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></textarea></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Opcionais</label>
                        <div class="border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="opcionaisGrid">
                                <!-- Ser√° preenchido via JS -->
                            </div>
                        </div>
                        <input type="hidden" id="opcionais">
                    </div>
                    <div id="uploadSection">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fotos do Ve√≠culo</label>
                        <div id="dropzone" class="dropzone rounded-lg p-8 text-center" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-4 text-gray-400"></i>
                            <p class="text-gray-600 font-medium">Arraste as fotos aqui ou clique para selecionar</p>
                            <p class="text-sm text-gray-400 mt-2">JPG, PNG at√© 10MB cada</p>
                        </div>
                        <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
                        <div id="previewContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-6 border-t">
                        <button type="button" onclick="fecharModalVeiculo()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">Cancelar</button>
                        <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium shadow-md">Salvar Ve√≠culo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modalDespesa" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Adicionar Despesa</h3>
                <button onclick="fecharModalDespesa()" class="p-2 hover:bg-gray-100 rounded-lg transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6">
                <form id="formDespesa" onsubmit="salvarDespesa(event)" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o*</label>
                        <input type="text" id="despesa_descricao" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Categoria*</label>
                        <select id="despesa_categoria" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <option value="">Selecione</option><option value="Aluguel">Aluguel</option><option value="√Ågua">√Ågua</option><option value="Luz">Luz</option><option value="Internet">Internet</option><option value="Marketing">Marketing</option><option value="Outros">Outros</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Valor*</label>
                        <input type="number" id="despesa_valor" required step="0.01" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-600 focus:border-transparent"></div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="fecharModalDespesa()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwAl9RYUGOO_aM_XoZG_YJuq6FlqCQO96jNBMyEz3SXvtA-hX4wnEVorNkYHR-UF0uO/exec';
        

const OPCIONAIS_DISPONIVEIS = ['Ar-condicionado', 'Dire√ß√£o hidr√°ulica', 'Dire√ß√£o el√©trica', 'Vidros el√©tricos', 'Travas el√©tricas', 'Retrovisores el√©tricos', 'Alarme', 'Air bag motorista', 'Air bag passageiro', 'Air bags laterais', 'ABS', 'Freios a disco', 'Sensor de estacionamento', 'C√¢mera de r√©', 'Controle de tra√ß√£o', 'Controle de estabilidade', 'Piloto autom√°tico', 'Computador de bordo', 'Bancos em couro', 'Bancos aquecidos', 'Volante com regulagem de altura', 'Volante multifuncional', 'R√°dio', 'CD player', 'Bluetooth', 'USB', 'Entrada auxiliar', 'Rodas de liga leve', 'Teto solar', 'Engate reboque', 'Rack de teto'];

const MARCAS_MODELOS = {
    'Volkswagen': ['Gol', 'Polo', 'Virtus', 'T-Cross', 'Nivus', 'Saveiro', 'Voyage', 'Fox', 'Up!'],
    'Fiat': ['Uno', 'Argo', 'Mobi', 'Cronos', 'Pulse', 'Fastback', 'Toro', 'Strada', 'Palio', 'Punto'],
    'Chevrolet': ['Onix', 'Tracker', 'S10', 'Montana', 'Spin', 'Cruze', 'Prisma', 'Celta'],
    'Ford': ['Ka', 'EcoSport', 'Ranger', 'Fiesta', 'Fusion', 'Focus'],
    'Hyundai': ['HB20', 'Creta', 'Tucson', 'i30', 'Santa Fe', 'Elantra', 'Azera'],
    'Toyota': ['Corolla', 'Hilux', 'Yaris', 'SW4', 'RAV4', 'Etios', 'Camry'],
    'Honda': ['Civic', 'City', 'HR-V', 'CR-V', 'Fit', 'WR-V', 'Accord'],
    'Renault': ['Kwid', 'Sandero', 'Logan', 'Duster', 'Captur', 'Oroch', 'Fluence'],
    'Nissan': ['Kicks', 'Versa', 'Frontier', 'Sentra', 'March', 'Livina'],
    'Jeep': ['Renegade', 'Compass', 'Commander', 'Wrangler', 'Cherokee'],
    'Peugeot': ['208', '2008', '3008', '5008', '308', '408'],
    'Citro√´n': ['C3', 'C4 Cactus', 'Aircross', 'Berlingo'],
    'Caoa Chery': ['Tiggo 5x', 'Tiggo 7', 'Tiggo 8', 'Arrizo 5', 'Arrizo 6'],
    'BMW': ['320i', 'X1', 'X3', 'X5', 'S√©rie 1', 'S√©rie 3', 'S√©rie 5'],
    'Mercedes-Benz': ['Classe A', 'Classe C', 'GLA', 'GLC', 'Sprinter'],
    'Audi': ['A3', 'A4', 'Q3', 'Q5', 'Q7'],
    'Mitsubishi': ['L200', 'Outlander', 'ASX', 'Eclipse Cross'],
    'BYD': ['Dolphin', 'Song Plus', 'Yuan Plus', 'Tan'],
    'GWM': ['Haval H6', 'Poer', 'Ora 03']
};

        let todosVeiculos = [];
        let todosLeads = [];
        let todasDespesas = [];
        let imagensSelecionadas = [];
        let veiculoEditando = null;

        document.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacao();
            popularMarcas();
            carregarDados();
            lucide.createIcons();
        });

        function verificarAutenticacao() {
            const auth = localStorage.getItem('admin_autenticado');
            const timestamp = localStorage.getItem('admin_timestamp');
            if (!auth || !timestamp || Date.now() - parseInt(timestamp) > 8*60*60*1000) {
                window.location.href = 'login.html';
            }
        }

        async function carregarDados() {
            mostrarToast('Atualizando dados...', 'info');
            await Promise.all([carregarDashboard(), carregarVeiculos(), carregarLeads(), carregarDespesas(), carregarClientes()]);
            lucide.createIcons();
        }

        async function carregarDashboard() {
            try {
                const res = await fetch(`${API_URL}?action=getDashboard`);
                const result = await res.json();
                if (result.success) {
                    const d = result.data.resumo;
                    document.getElementById('statEstoque').textContent = d.totalEstoque;
                    document.getElementById('statVendidos').textContent = d.veiculosVendidos;
                    document.getElementById('statLucro').textContent = formatarMoeda(d.lucroTotal);
                    document.getElementById('statLeads').textContent = d.totalLeads;
                }
            } catch (e) { console.error('Erro ao carregar dashboard:', e); }
        }

        async function carregarVeiculos() {
            try {
                const res = await fetch(`${API_URL}?action=getVeiculos`);
                const result = await res.json();
                if (result.success) {
                    todosVeiculos = result.data;
                    renderizarVeiculos();
                }
            } catch (e) { mostrarToast('Erro ao carregar ve√≠culos', 'error'); }
        }

        function converterImagem(url) {
            if (!url || url === '' || url.includes('/folders/')) return '';
            const match = url.match(/[-\w]{25,}/);
            return match ? 'https://drive.google.com/thumbnail?id=' + match[0] + '&sz=w200' : '';
        }

        function renderizarVeiculos() {
            const lista = document.getElementById('listaVeiculos');
            if (todosVeiculos.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum ve√≠culo cadastrado</p>';
                return;
            }
            lista.innerHTML = todosVeiculos.map(v => `
                <div class="border border-gray-200 rounded-lg p-4 flex gap-4 hover:shadow-md transition">
                    <img src="${converterImagem(v.imagem_principal)}" 
                         alt="${v.marca} ${v.modelo}" 
                         class="w-24 h-24 object-cover rounded-lg flex-shrink-0"
                         onerror="this.src='https://placehold.co/96x96/e2e8f0/94a3b8?text=Sem+Foto'">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg text-gray-800">${v.marca} ${v.modelo} ${v.ano}</h4>
                        <p class="text-sm text-gray-600">${formatarKm(v.km)} km ‚Ä¢ ${v.cambio} ‚Ä¢ ${v.combustivel}</p>
                        <p class="text-purple-600 font-bold text-lg mt-1">${formatarMoeda(v.valor_anunciado)}</p>
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 ${v.status==='Dispon√≠vel'?'bg-green-100 text-green-800':v.status==='Vendido'?'bg-blue-100 text-blue-800':'bg-yellow-100 text-yellow-800'}">${v.status}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editarVeiculo(${v.id})" class="p-3 hover:bg-gray-100 rounded-lg transition" title="Editar"><i data-lucide="edit" class="w-5 h-5 text-gray-600"></i></button>
                        <button onclick="excluirVeiculo(${v.id})" class="p-3 hover:bg-red-100 text-red-600 rounded-lg transition" title="Excluir"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function abrirModalVeiculo() {
            veiculoEditando = null;
            document.getElementById('modalVeiculoTitulo').textContent = 'Adicionar Ve√≠culo';
            document.getElementById('formVeiculo').reset();
            document.getElementById('veiculoId').value = '';
            document.getElementById('veiculoPastaId').value = '';
            
            // Popular opcionais quando abrir o modal
            popularOpcionais();
            document.querySelectorAll('#opcionaisGrid input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            imagensSelecionadas = [];
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('modalVeiculo').classList.remove('hidden');
            lucide.createIcons();
        }

        function fecharModalVeiculo() {
            document.getElementById('modalVeiculo').classList.add('hidden');
        }

        async function editarVeiculo(id) {
            veiculoEditando = id;
            const veiculo = todosVeiculos.find(v => v.id === id);
            if (!veiculo) return;
            document.getElementById('modalVeiculoTitulo').textContent = 'Editar Ve√≠culo';
            document.getElementById('veiculoId').value = veiculo.id;
            // Extrair pastaId da URL da pasta_drive
            let pastaIdEdit = '';
            if (veiculo.pasta_drive) {
                const match = veiculo.pasta_drive.match(/\/folders\/([a-zA-Z0-9-_]+)/);
                if (match) pastaIdEdit = match[1];
            }
            document.getElementById('veiculoPastaId').value = pastaIdEdit;
            console.log('Editando ve√≠culo ID:', veiculo.id, 'PastaID:', pastaIdEdit);
            document.getElementById('marca').value = veiculo.marca;
            document.getElementById('modelo').value = veiculo.modelo;
            document.getElementById('ano').value = veiculo.ano;
            document.getElementById('km').value = veiculo.km;
            document.getElementById('cor').value = veiculo.cor;
            document.getElementById('placa').value = veiculo.placa || '';
            document.getElementById('cambio').value = veiculo.cambio;
            document.getElementById('combustivel').value = veiculo.combustivel;
            document.getElementById('valor_compra').value = veiculo.valor_compra;
            document.getElementById('custos_adicionais').value = veiculo.custos_adicionais || 0;
            document.getElementById('valor_anunciado').value = veiculo.valor_anunciado;
            document.getElementById('status').value = veiculo.status;
            document.getElementById('descricao').value = veiculo.descricao || '';
            // Popular opcionais antes de marcar
            popularOpcionais();
            marcarOpcionais(veiculo.opcionais || '');
            
            imagensSelecionadas = [];
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('modalVeiculo').classList.remove('hidden');
            lucide.createIcons();
        }

        async function salvarVeiculo(e) {
            e.preventDefault();
            const dados = {
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                ano: document.getElementById('ano').value,
                km: document.getElementById('km').value,
                cor: document.getElementById('cor').value,
                placa: document.getElementById('placa').value,
                cambio: document.getElementById('cambio').value,
                combustivel: document.getElementById('combustivel').value,
                valor_compra: document.getElementById('valor_compra').value,
                custos_adicionais: document.getElementById('custos_adicionais').value || 0,
                valor_anunciado: document.getElementById('valor_anunciado').value,
                status: document.getElementById('status').value,
                descricao: document.getElementById('descricao').value,
                opcionais: document.getElementById('opcionais').value
            };
            console.log('üíæ Salvando ve√≠culo:', dados);
            try {
                let action = 'addVeiculo';
                if (veiculoEditando) {
                    action = 'updateVeiculo';
                    dados.id = veiculoEditando;
                }
                const res = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                const result = await res.json();
                console.log('üìä Resultado do salvamento:', result);
                console.log('üìÅ pastaId:', result.pastaId);
                console.log('üñºÔ∏è Imagens selecionadas:', imagensSelecionadas.length);
                if (result.success) {
                    if (imagensSelecionadas.length > 0) {
                        // Se estiver editando, usar o pastaId salvo no campo hidden
                        let pastaIdParaUpload = result.pastaId;
                        if (veiculoEditando && !pastaIdParaUpload) {
                            pastaIdParaUpload = document.getElementById('veiculoPastaId').value;
                            console.log('üìÇ Usando pastaId do ve√≠culo existente:', pastaIdParaUpload);
                        }
                        // Ao editar, result.id pode n√£o vir, ent√£o usa veiculoEditando
                        const veiculoIdParaUpload = result.id || veiculoEditando;
                        console.log('üì∏ Iniciando upload de', imagensSelecionadas.length, 'imagens');
                        console.log('üóÇÔ∏è Pasta ID:', pastaIdParaUpload);
                        console.log('üì¶ Ve√≠culo ID:', veiculoIdParaUpload);
                        if (!pastaIdParaUpload) {
                            console.error('‚ùå Sem pastaId para upload!');
                            mostrarToast('Ve√≠culo salvo! Para adicionar fotos, edite o ve√≠culo.', 'success');
                        } else {
                        try {
                            console.log('üì§ Enviando imagens uma por uma...');
                            let erros = 0;
                            for (let imgIdx = 0; imgIdx < imagensSelecionadas.length; imgIdx++) {
                                const img = imagensSelecionadas[imgIdx];
                                const dadosImg = {
                                    veiculoId: veiculoIdParaUpload,
                                    pastaId: pastaIdParaUpload,
                                    imagens: [img]
                                };
                                console.log('üì∏ Enviando imagem ' + (imgIdx+1) + '/' + imagensSelecionadas.length + ': ' + img.nome);
                                try {
                                    const r = await fetch(API_URL + '?action=uploadMultiplasImagens', {
                                        method: 'POST',
                                        body: JSON.stringify(dadosImg)
                                    });
                                    const rj = await r.json();
                                    console.log('Resultado img ' + (imgIdx+1) + ':', rj);
                                    if (!rj.success) erros++;
                                } catch(imgErr) {
                                    console.error('Erro img ' + (imgIdx+1) + ':', imgErr);
                                    erros++;
                                }
                            }
                            if (erros === 0) {
                                mostrarToast('Ve√≠culo e ' + imagensSelecionadas.length + ' foto(s) salvas com sucesso!', 'success');
                            } else {
                                mostrarToast('Ve√≠culo salvo. ' + erros + ' foto(s) com erro.', 'error');
                            }
                        } catch (uploadError) {
                            console.error('‚ùå Erro ao enviar fotos:', uploadError);
                            mostrarToast('Ve√≠culo salvo, mas erro ao enviar fotos', 'error');
                        }
                        } // fecha if pastaId
                    } else {
                        console.log('‚ö†Ô∏è Sem imagens para upload ou editando ve√≠culo existente');
                        mostrarToast(veiculoEditando ? 'Ve√≠culo atualizado!' : 'Ve√≠culo adicionado!', 'success');
                    }
                    fecharModalVeiculo();
                    await carregarVeiculos();
                    await carregarDashboard();
                } else {
                    mostrarToast('Erro ao salvar ve√≠culo: ' + result.error, 'error');
                }
            } catch (e) {
                console.error('‚ùå Erro:', e);
                mostrarToast('Erro ao salvar ve√≠culo', 'error');
            }
        }

        async function excluirVeiculo(id) {
            if (!confirm('Deseja realmente excluir este ve√≠culo?')) return;
            try {
                const res = await fetch(`${API_URL}?action=deleteVeiculo`, {method: 'POST', body: JSON.stringify({ id })});
                const result = await res.json();
                if (result.success) {
                    mostrarToast('Ve√≠culo exclu√≠do!', 'success');
                    await carregarVeiculos();
                    await carregarDashboard();
                }
            } catch (e) { mostrarToast('Erro ao excluir ve√≠culo', 'error'); }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            console.log('üìÇ Arquivos selecionados:', files.length);
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log('‚úÖ Imagem adicionada:', file.name, 'Total:', imagensSelecionadas.length + 1);
                    imagensSelecionadas.push({
                        nome: file.name,
                        base64: e.target.result,
                        isPrincipal: imagensSelecionadas.length === 0
                    });
                    renderizarPreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderizarPreviews() {
            const container = document.getElementById('previewContainer');
            container.innerHTML = imagensSelecionadas.map((img, idx) => `
                <div class="relative group">
                    <img src="${img.base64}" class="preview-img shadow-md">
                    <button type="button" onclick="removerImagem(${idx})" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition">√ó</button>
                    ${img.isPrincipal ? '<span class="absolute bottom-2 left-2 bg-purple-600 text-white text-xs px-3 py-1 rounded-full shadow-md font-semibold">Principal</span>' : ''}
                </div>
            `).join('');
        }

        function removerImagem(idx) {
            imagensSelecionadas.splice(idx, 1);
            if (imagensSelecionadas.length > 0 && !imagensSelecionadas.some(i => i.isPrincipal)) {
                imagensSelecionadas[0].isPrincipal = true;
            }
            renderizarPreviews();
        }

        async function carregarLeads() {
            try {
                const res = await fetch(`${API_URL}?action=getLeads`);
                const result = await res.json();
                if (result.success) {
                    todosLeads = result.data;
                    renderizarLeads();
                }
            } catch (e) { mostrarToast('Erro ao carregar leads', 'error'); }
        }

        function renderizarLeads() {
            const lista = document.getElementById('listaLeads');
            if (todosLeads.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum lead recebido</p>';
                return;
            }
            lista.innerHTML = todosLeads.map(l => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${l.veiculo_interesse}</h4>
                            <p class="text-sm text-gray-600 mt-1">${l.telefone || 'Sem telefone'}</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(l.data_hora).toLocaleString('pt-BR')}</p>
                        </div>
                        <select onchange="atualizarStatusLead(${l.id}, this.value)" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <option value="Novo" ${l.status==='Novo'?'selected':''}>Novo</option>
                            <option value="Contatado" ${l.status==='Contatado'?'selected':''}>Contatado</option>
                            <option value="Negociando" ${l.status==='Negociando'?'selected':''}>Negociando</option>
                            <option value="Convertido" ${l.status==='Convertido'?'selected':''}>Convertido</option>
                            <option value="Perdido" ${l.status==='Perdido'?'selected':''}>Perdido</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        async function atualizarStatusLead(id, status) {
            try {
                const res = await fetch(`${API_URL}?action=updateLead`, {method: 'POST', body: JSON.stringify({ id, status })});
                const result = await res.json();
                if (result.success) {
                    mostrarToast('Lead atualizado!', 'success');
                    await carregarLeads();
                    await carregarDashboard();
                }
            } catch (e) { mostrarToast('Erro ao atualizar lead', 'error'); }
        }

        async function carregarDespesas() {
            try {
                const res = await fetch(`${API_URL}?action=getDespesas`);
                const result = await res.json();
                if (result.success) {
                    todasDespesas = result.data;
                    renderizarDespesas();
                }
            } catch (e) { mostrarToast('Erro ao carregar despesas', 'error'); }
        }

        function renderizarDespesas() {
            const lista = document.getElementById('listaDespesas');
            if (todasDespesas.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma despesa cadastrada</p>';
                return;
            }
            lista.innerHTML = todasDespesas.map(d => `
                <div class="border border-gray-200 rounded-lg p-4 flex justify-between items-center hover:shadow-md transition">
                    <div>
                        <h4 class="font-bold text-gray-800">${d.descricao}</h4>
                        <p class="text-sm text-gray-600">${d.categoria}</p>
                        <p class="text-purple-600 font-bold text-lg mt-1">${formatarMoeda(d.valor)}</p>
                    </div>
                    <button onclick="excluirDespesa(${d.id})" class="p-3 hover:bg-red-100 text-red-600 rounded-lg transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function abrirModalDespesa() {
            document.getElementById('formDespesa').reset();
            document.getElementById('modalDespesa').classList.remove('hidden');
        }

        function fecharModalDespesa() {
            document.getElementById('modalDespesa').classList.add('hidden');
        }

        async function salvarDespesa(e) {
            e.preventDefault();
            const dados = {
                descricao: document.getElementById('despesa_descricao').value,
                categoria: document.getElementById('despesa_categoria').value,
                valor: document.getElementById('despesa_valor').value
            };
            try {
                const res = await fetch(`${API_URL}?action=addDespesa`, {method: 'POST', body: JSON.stringify(dados)});
                const result = await res.json();
                if (result.success) {
                    mostrarToast('Despesa adicionada!', 'success');
                    fecharModalDespesa();
                    await carregarDespesas();
                    await carregarDashboard();
                }
            } catch (e) { mostrarToast('Erro ao adicionar despesa', 'error'); }
        }

        async function excluirDespesa(id) {
            if (!confirm('Deseja realmente excluir esta despesa?')) return;
            try {
                const res = await fetch(`${API_URL}?action=deleteDespesa`, {method: 'POST', body: JSON.stringify({ id })});
                const result = await res.json();
                if (result.success) {
                    mostrarToast('Despesa exclu√≠da!', 'success');
                    await carregarDespesas();
                    await carregarDashboard();
                }
            } catch (e) { mostrarToast('Erro ao excluir despesa', 'error'); }
        }

        function mostrarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${aba}`).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelector(`[data-tab="${aba}"]`).classList.add('active');
            const titulos = {dashboard: 'Dashboard', veiculos: 'Ve√≠culos', leads: 'Leads', despesas: 'Despesas'};
            document.getElementById('tituloAba').textContent = titulos[aba];
            lucide.createIcons();
        }

        function sair() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('admin_autenticado');
                localStorage.removeItem('admin_timestamp');
                window.location.href = 'login.html';
            }
        }

        function mostrarToast(msg, tipo) {
            const cores = {success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500'};
            const toast = document.createElement('div');
            toast.className = `toast ${cores[tipo] || 'bg-gray-500'} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center space-x-3`;
            toast.innerHTML = `<i data-lucide="${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'alert-circle' : 'info'}" class="w-5 h-5"></i><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(valor || 0);
        }

        function formatarKm(km) {
            return new Intl.NumberFormat('pt-BR').format(km || 0);
        }

        function popularOpcionais() {
            console.log('Populando opcionais...');
            const grid = document.getElementById('opcionaisGrid');
            if (!grid) {
                console.error('opcionaisGrid n√£o encontrado!');
                return;
            }
            console.log('Opcionais dispon√≠veis:', OPCIONAIS_DISPONIVEIS.length);
            grid.innerHTML = OPCIONAIS_DISPONIVEIS.map((op, idx) => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" 
                           value="${op}" 
                           onchange="atualizarOpcionais()"
                           class="w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-600">
                    <span class="text-sm text-gray-700">${op}</span>
                </label>
            `).join('');
            console.log('Opcionais renderizados:', grid.children.length, 'itens');
        }

        function atualizarOpcionais() {
            const checks = document.querySelectorAll('#opcionaisGrid input[type="checkbox"]:checked');
            const selecionados = Array.from(checks).map(c => c.value);
            document.getElementById('opcionais').value = selecionados.join(', ');
        }

        function marcarOpcionais(opcionaisStr) {
            if (!opcionaisStr) return;
            const lista = opcionaisStr.split(',').map(s => s.trim());
            document.querySelectorAll('#opcionaisGrid input[type="checkbox"]').forEach(cb => {
                cb.checked = lista.includes(cb.value);
            });
        }

        function popularMarcas() {
            const datalist = document.getElementById('listaMarcas');
            datalist.innerHTML = Object.keys(MARCAS_MODELOS).sort().map(m => 
                `<option value="${m}">`
            ).join('');
        }

        function atualizarModelos() {
            const marca = document.getElementById('marca').value;
            const datalist = document.getElementById('listaModelos');
            const modelos = MARCAS_MODELOS[marca] || [];
            datalist.innerHTML = modelos.map(m => `<option value="${m}">`).join('');
        }

        function toggleSidebar() {
            console.log('Toggle sidebar chamado');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar) {
                console.error('Sidebar n√£o encontrado!');
                return;
            }
            if (!overlay) {
                console.error('Overlay n√£o encontrado!');
                return;
            }
            
            const isOpen = sidebar.classList.contains('open');
            console.log('Estado atual:', isOpen ? 'aberto' : 'fechado');
            
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
            
            console.log('Novo estado:', sidebar.classList.contains('open') ? 'aberto' : 'fechado');
        }
    
        // ============================================
        // CLIENTES
        // ============================================
        let todosClientes = [];
        let clienteEditando = null;

        async function carregarClientes() {
            try {
                const response = await fetch(`${API_URL}?action=getClientes`);
                const result = await response.json();
                if (result.success) {
                    todosClientes = result.data;
                    renderizarClientes();
                }
            } catch (e) {
                mostrarToast('Erro ao carregar clientes', 'error');
            }
        }

        function renderizarClientes() {
            const lista = document.getElementById('listaClientes');
            if (todosClientes.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum cliente cadastrado</p>';
                return;
            }
            lista.innerHTML = todosClientes.map(c => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-gray-800">${c.nome}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i data-lucide="credit-card" class="w-4 h-4 mr-2"></i>
                                    ${c.cpf || 'CPF n√£o informado'}
                                </div>
                                <div class="flex items-center">
                                    <i data-lucide="phone" class="w-4 h-4 mr-2"></i>
                                    ${c.telefone || 'Telefone n√£o informado'}
                                </div>
                                <div class="flex items-center">
                                    <i data-lucide="mail" class="w-4 h-4 mr-2"></i>
                                    ${c.email || 'Email n√£o informado'}
                                </div>
                                <div class="flex items-center">
                                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                                    ${c.cidade && c.estado ? c.cidade + ' - ' + c.estado : 'Endere√ßo n√£o informado'}
                                </div>
                            </div>
                            ${c.observacoes ? '<p class="mt-2 text-sm text-gray-500 italic">' + c.observacoes + '</p>' : ''}
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editarCliente(${c.id})" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Editar">
                                <i data-lucide="edit" class="w-5 h-5 text-gray-600"></i>
                            </button>
                            <button onclick="excluirCliente(${c.id})" class="p-2 hover:bg-red-100 text-red-600 rounded-lg transition" title="Excluir">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function abrirModalCliente() {
            clienteEditando = null;
            document.getElementById('modalClienteTitulo').textContent = 'Adicionar Cliente';
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('modalCliente').classList.remove('hidden');
            lucide.createIcons();
        }

        function fecharModalCliente() {
            document.getElementById('modalCliente').classList.add('hidden');
        }

        async function editarCliente(id) {
            clienteEditando = id;
            const cliente = todosClientes.find(c => c.id === id);
            if (!cliente) return;

            document.getElementById('modalClienteTitulo').textContent = 'Editar Cliente';
            document.getElementById('clienteId').value = cliente.id;
            document.getElementById('clienteNome').value = cliente.nome || '';
            document.getElementById('clienteCpf').value = cliente.cpf || '';
            document.getElementById('clienteTelefone').value = cliente.telefone || '';
            document.getElementById('clienteEmail').value = cliente.email || '';
            document.getElementById('clienteEndereco').value = cliente.endereco || '';
            document.getElementById('clienteCidade').value = cliente.cidade || '';
            document.getElementById('clienteEstado').value = cliente.estado || '';
            document.getElementById('clienteCep').value = cliente.cep || '';
            document.getElementById('clienteObservacoes').value = cliente.observacoes || '';
            document.getElementById('modalCliente').classList.remove('hidden');
            lucide.createIcons();
        }

        async function salvarCliente(e) {
            e.preventDefault();
            
            const dados = {
                nome: document.getElementById('clienteNome').value,
                cpf: document.getElementById('clienteCpf').value,
                telefone: document.getElementById('clienteTelefone').value,
                email: document.getElementById('clienteEmail').value,
                endereco: document.getElementById('clienteEndereco').value,
                cidade: document.getElementById('clienteCidade').value,
                estado: document.getElementById('clienteEstado').value,
                cep: document.getElementById('clienteCep').value,
                observacoes: document.getElementById('clienteObservacoes').value
            };

            const action = clienteEditando ? 'updateCliente' : 'addCliente';
            if (clienteEditando) dados.id = clienteEditando;

            try {
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                const result = await response.json();
                
                if (result.success) {
                    mostrarToast('Cliente salvo com sucesso!', 'success');
                    fecharModalCliente();
                    await carregarClientes();
                } else {
                    mostrarToast('Erro ao salvar cliente: ' + result.error, 'error');
                }
            } catch (e) {
                mostrarToast('Erro ao salvar cliente', 'error');
            }
        }

        async function excluirCliente(id) {
            if (!confirm('Deseja realmente excluir este cliente?')) return;

            try {
                const response = await fetch(`${API_URL}?action=deleteCliente`, {
                    method: 'POST',
                    body: JSON.stringify({ id: id })
                });
                const result = await response.json();
                
                if (result.success) {
                    mostrarToast('Cliente exclu√≠do com sucesso!', 'success');
                    await carregarClientes();
                } else {
                    mostrarToast('Erro ao excluir cliente', 'error');
                }
            } catch (e) {
                mostrarToast('Erro ao excluir cliente', 'error');
            }
        }


        function verDetalhesVeiculo(id) {
            // Abre a p√°gina de detalhes em nova aba
            window.open('veiculo-detalhes.html?id=' + id, '_blank');
        }

</script>

    <!-- Modal Cliente -->
    <div id="modalCliente" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-2xl font-bold text-gray-800" id="modalClienteTitulo">Adicionar Cliente</h3>
                <button onclick="fecharModalCliente()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="formCliente" onsubmit="salvarCliente(event)" class="space-y-4">
                    <input type="hidden" id="clienteId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo*</label>
                            <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CPF*</label>
                            <input type="text" id="clienteCpf" required placeholder="000.000.000-00" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone*</label>
                            <input type="text" id="clienteTelefone" required placeholder="(00) 00000-0000" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="clienteEmail" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                            <input type="text" id="clienteEndereco" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                            <input type="text" id="clienteCidade" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                            <input type="text" id="clienteEstado" maxlength="2" placeholder="MG" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                            <input type="text" id="clienteCep" placeholder="00000-000" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                            <textarea id="clienteObservacoes" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="fecharModalCliente()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">Cancelar</button>
                        <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium shadow-md">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
